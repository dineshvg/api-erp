name: Notify on Upstream Repository Changes

on:
  schedule:
    # Poll the upstream repo every hour
    - cron: '0 * * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  actions: write # Required to update repository variables

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    steps:
      - name: Get latest upstream commit SHA via GitHub API
        id: upstream_check
        run: |
          # Fetch the latest commit SHA on upstream master via GitHub API (no git clone needed)
          UPSTREAM_SHA=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/gematik/api-erp/commits/master" \
            | jq -r '.sha')

          echo "upstream_sha=$UPSTREAM_SHA" >> $GITHUB_OUTPUT

          # Compare against the last known SHA stored as a repo variable
          LAST_KNOWN_SHA="${{ vars.LAST_UPSTREAM_SHA }}"

          echo "last_known_sha=$LAST_KNOWN_SHA" >> $GITHUB_OUTPUT

          if [ "$UPSTREAM_SHA" != "$LAST_KNOWN_SHA" ] && [ -n "$UPSTREAM_SHA" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT

            # Get commit details
            COMMIT_JSON=$(curl -s \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/gematik/api-erp/commits/master")

            COMMIT_MSG=$(echo "$COMMIT_JSON" | jq -r '.commit.message | split("\n")[0]')
            COMMIT_AUTHOR=$(echo "$COMMIT_JSON" | jq -r '.commit.author.name')
            COMMIT_DATE=$(echo "$COMMIT_JSON" | jq -r '.commit.author.date')

            echo "commit_message=$COMMIT_MSG" >> $GITHUB_OUTPUT
            echo "commit_author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT
            echo "commit_date=$COMMIT_DATE" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Update last known upstream SHA variable
        if: steps.upstream_check.outputs.has_changes == 'true'
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" -X PATCH \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/variables/LAST_UPSTREAM_SHA" \
            -d "{\"name\":\"LAST_UPSTREAM_SHA\",\"value\":\"${{ steps.upstream_check.outputs.upstream_sha }}\"}"
          )
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          if [ "$HTTP_CODE" -eq 204 ] || [ "$HTTP_CODE" -eq 200 ]; then
            echo "Successfully updated LAST_UPSTREAM_SHA variable"
            echo "update_success=true" >> $GITHUB_OUTPUT
          else
            echo "Failed to update LAST_UPSTREAM_SHA variable. HTTP Code: $HTTP_CODE"
            echo "Response: $BODY"
            echo "update_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Post to Microsoft Teams channel
        if: steps.upstream_check.outputs.has_changes == 'true'
        run: |
          curl -H 'Content-Type: application/json' \
               -d '{
                 "text": "**[api-erp] Upstream Change Detected!**\n\n**Commit:** `${{ steps.upstream_check.outputs.upstream_sha }}`\n**Author:** ${{ steps.upstream_check.outputs.commit_author }}\n**Date:** ${{ steps.upstream_check.outputs.commit_date }}\n**Message:** ${{ steps.upstream_check.outputs.commit_message }}\n\n[View on GitHub](https://github.com/gematik/api-erp/commit/${{ steps.upstream_check.outputs.upstream_sha }})"
               }' \
               '${{ secrets.TEAMS_WEBHOOK_URL }}'
