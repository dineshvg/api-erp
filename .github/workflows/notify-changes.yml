name: Notify on Upstream Repository Changes

on:
  schedule:
    # Poll the upstream repo every hour
    - cron: '0 * * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for upstream changes
        id: upstream_check
        run: |
          # Add the upstream remote
          git remote add upstream https://github.com/gematik/api-erp.git
          git fetch upstream

          # Get the latest commit SHA on upstream master
          UPSTREAM_SHA=$(git rev-parse upstream/master)
          FORK_SHA=$(git rev-parse origin/master)

          echo "upstream_sha=$UPSTREAM_SHA" >> $GITHUB_OUTPUT
          echo "fork_sha=$FORK_SHA" >> $GITHUB_OUTPUT

          if [ "$UPSTREAM_SHA" != "$FORK_SHA" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT

            # Count new commits
            NEW_COMMITS=$(git log origin/master..upstream/master --oneline | wc -l | tr -d ' ')
            echo "new_commits=$NEW_COMMITS" >> $GITHUB_OUTPUT

            # Get details of new commits
            COMMIT_LOG=$(git log origin/master..upstream/master --pretty=format:'- %s (%an, %ci)' | head -10)
            echo "commit_log<<EOF" >> $GITHUB_OUTPUT
            echo "$COMMIT_LOG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Post to Microsoft Teams channel
        if: steps.upstream_check.outputs.has_changes == 'true'
        run: |
          curl -H 'Content-Type: application/json' \
               -d '{
                 "text": "**[api-erp] Upstream Changes Detected!**\n\n**New commits on gematik/api-erp:** ${{ steps.upstream_check.outputs.new_commits }}\n\n**Recent changes:**\n${{ steps.upstream_check.outputs.commit_log }}\n\n[View upstream changes](https://github.com/gematik/api-erp/compare/${{ steps.upstream_check.outputs.fork_sha }}...${{ steps.upstream_check.outputs.upstream_sha }})"
               }' \
               '${{ secrets.TEAMS_WEBHOOK_URL }}'
